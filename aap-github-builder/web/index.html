<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HTML ‚Üí AAP Converter</title>
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' blob: data:; script-src 'self' 'unsafe-inline'; worker-src 'self' blob:; connect-src 'self' https://api.mybuilder.xyz https://your-builder.example.com; style-src 'self' 'unsafe-inline'; object-src 'none'; base-uri 'self'; frame-ancestors 'self'; form-action 'self'; manifest-src 'self'">
<base href="./">
<style>
  :root{
    --bg:#f6f7fb; --fg:#222; --card:#fff;
    --pri:#4caf50; --pri-700:#388e3c; --sec:#2196f3; --mut:#7a7a7a; --brd:#e4e6ee;
    --text-color: var(--fg);
  }
  *{box-sizing:border-box}
  body {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    margin: 0;
    font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
    background-color: var(--bg);
    color: var(--fg);
    line-height: 1.6;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
  }
  .card{
    width:min(92vw,780px);
    background:var(--card);
    border:1px solid var(--brd);
    border-radius:16px;
    box-shadow:0 10px 24px rgba(20,20,20,.08);
    padding:20px 20px 16px;
    display:flex;
    flex-direction:column;
    gap:16px
  }
  h1{ margin:4px 0 0; font-size: clamp(1.5rem, 3vw, 2.5rem); font-weight:700; text-align: center; color: var(--pri); }
  p.lead{ margin:0; color:var(--mut); font-size: clamp(.9rem, 2vw, 1.1rem); text-align: center; }
  .grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
  .row{ display:flex; flex-direction:column; gap:6px }
  label{ font-size: clamp(.9rem, 2vw, 1.1rem); font-weight:600; color: var(--text-color); }
  input[type="text"],input[type="number"]{ border:1px solid var(--brd); border-radius:10px; padding:12px 12px; font-size: clamp(.9rem, 2vw, 1.1rem); outline:none; transition: border-color 0.3s ease; }
  input:focus{ border-color:var(--sec); }
  .drop{ border:2px dashed var(--sec); border-radius:12px; padding:18px; text-align:center; color:#2a2a2a; background:#f0f7ff; transition: background-color 0.3s ease; cursor: pointer; outline: none; }
  .drop.drag{ background:#e6f2ff; }
  .small{ font-size: clamp(.8rem, 1.5vw, .95rem); color:var(--mut); }
  .files{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top: 10px; }
  .chip{ border:1px solid var(--brd); border-radius:999px; padding:6px 10px; font-size: clamp(.8rem, 1.5vw, .95rem); background:#fafbff; white-space: nowrap; }
  .hidden{ display:none }
  .btn{ appearance:none; border:0; border-radius:10px; padding:12px 16px; background:var(--pri); color:#fff; font-weight:700; font-size: clamp(1rem, 2.5vw, 1.25rem); cursor:pointer; box-shadow:0 6px 18px rgba(76,175,80,.25); transition:transform .05s ease, background-color 0.3s ease; touch-action: manipulation; }
  .btn:disabled{ opacity:.6; cursor:not-allowed; }
  .btn:hover{ background:var(--pri-700); transform: translateY(-2px); }
  .actions{ display:flex; gap:12px; justify-content:flex-end; margin-top: 10px; }
  .progress-wrap{ height:10px; background:#edf0f5; border-radius:99px; overflow:hidden; margin-top: 10px; }
  .bar{ height:100%; width:0; background:var(--sec); transition:width .35s ease; }
  details{ border:1px solid var(--brd); border-radius:12px; padding:10px; background: var(--card); }
  summary{ font-weight:700; cursor:pointer; font-size: clamp(.9rem, 2vw, 1.1rem); color: var(--text-color); }
  details[open] summary { margin-bottom: 10px; }
  #out{ border-left:4px solid var(--pri); background:#eef8ef; border-radius:8px; padding:12px; min-height:44px; display:flex; align-items:center; justify-content:center; text-align:center; font-size: clamp(.9rem, 2vw, 1.1rem); color: var(--text-color); transition: border-left-color 0.3s ease, background-color 0.3s ease; outline: 0; }
  #out.error{ border-left-color:#e53935; background:#fdeeee; color:#b71c1c; }
  #out.info{ border-left-color:var(--sec); background:#eef6ff; color:#0d47a1; }
  #out.success a { color: var(--pri); font-weight: bold; text-decoration: none; }
  #out.success a:hover { text-decoration: underline; }
  @media (max-width: 768px){ .card{ width: 95vw; padding: 16px; } .grid{ grid-template-columns: 1fr; } .actions{ justify-content: center; flex-direction: column; } .btn{ width:100%; } }
</style>
</head>
<body>
  <div class="card" aria-busy="false">
    <div>
      <h1>HTML ‚Üí AAP Converter üöÄ</h1>
      <p class="lead">Drop your HTML (required) and assets ZIP. We‚Äôll package a testable .aap stub you can download.</p>
    </div>

    <div id="drop" class="drop" tabindex="0" aria-label="Drop zone">
      <strong>Drop files here</strong> or <button id="pick" type="button" class="btn" style="padding:8px 12px;font-size:.95rem;">Choose files</button>
      <div class="small">Accepted: .html (required), .zip (optional), .png icon (512√ó512 optional)</div>
      <input id="picker" type="file" accept=".html,text/html,.zip,application/zip,.png,image/png" class="hidden" multiple>
      <div id="files" class="files"></div>
    </div>

    <div class="grid">
      <div class="row">
        <label for="appName">App name</label>
        <input id="appName" type="text" placeholder="My Awesome App">
      </div>
      <div class="row">
        <label for="pkg">Package name</label>
        <input id="pkg" type="text" placeholder="com.example.myapp">
        <div class="small">Auto-filled from app name; you can edit.</div>
      </div>
    </div>

    <details>
      <summary>Advanced settings</summary>
      <div class="grid" style="margin-top:10px">
        <div class="row">
          <label for="verCode">Version code</label>
          <input id="verCode" type="number" min="1" value="1">
        </div>
        <div class="row">
          <label for="verName">Version name</label>
          <input id="verName" type="text" value="1.0">
        </div>
        <div class="row">
          <label for="minSdk">Min SDK</label>
          <input id="minSdk" type="number" value="21">
        </div>
        <div class="row">
          <label for="tgtSdk">Target SDK</label>
          <input id="tgtSdk" type="number" value="35">
        </div>
        <div class="row" style="grid-column:1/3">
          <label for="perms">Permissions (comma or space separated)</label>
          <input id="perms" type="text" placeholder="INTERNET, ACCESS_NETWORK_STATE">
        </div>
      </div>
    </details>

    <div class="progress-wrap" aria-hidden="true">
      <div id="bar" class="bar" role="progressbar" aria-label="Upload and build progress" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>
    </div>
    <div id="out" class="info" aria-live="polite" tabindex="-1">Ready. Add files and I‚Äôll convert.</div>

    <div class="actions">
      <button id="reset" type="button" class="btn" style="background:#e53935">Reset üîÑ</button>
      <button id="go" type="button" class="btn">Convert to AAP üõ†Ô∏è</button>
      <button id="buildCloud" type="button" class="btn">Build AAB (Cloud) üì¶</button>
      <button id="buildApk" type="button" class="btn">Build APK (Cloud) üì±</button>
    </div>
  </div>

<script>
  const picker = document.getElementById('picker');
  const pickBtn = document.getElementById('pick');
  const drop = document.getElementById('drop');
  const filesDiv = document.getElementById('files');
  const appNameInput = document.getElementById('appName');
  const pkgInput = document.getElementById('pkg');
  const verCodeInput = document.getElementById('verCode');
  const verNameInput = document.getElementById('verName');
  const minSdkInput = document.getElementById('minSdk');
  const tgtSdkInput = document.getElementById('tgtSdk');
  const permsInput = document.getElementById('perms');
  const goBtn = document.getElementById('go');
  const resetBtn = document.getElementById('reset');
  const buildCloudBtn = document.getElementById('buildCloud');
  const buildApkBtn = document.getElementById('buildApk');
  const outputDiv = document.getElementById('out');
  const progressBar = document.getElementById('bar');
  const card = document.querySelector('.card');

  const APP_STORAGE_KEY = 'html_to_aap_converter';
  const CLOUD_BASE = 'https://api.mybuilder.xyz';

  let htmlFile = null;
  let assetsZipFile = null;
  let iconFile = null;

  function setStatus(kind, msg) { outputDiv.className = kind; outputDiv.textContent = msg; }
  function setBusy(b) {
    card.setAttribute('aria-busy', b ? 'true' : 'false');
    goBtn.disabled = b; resetBtn.disabled = b;
    buildCloudBtn.disabled = b || !htmlFile; buildApkBtn.disabled = b || !htmlFile;
  }
  function setProgress(p) {
    const v = Math.max(0, Math.min(100, Math.round(p)));
    progressBar.style.width = v + '%';
    progressBar.setAttribute('aria-valuenow', String(v));
  }

  function updateAppNameFromHtml() {
    if (!htmlFile) return;
    const r = new FileReader();
    r.onload = (e) => {
      const content = e.target.result;
      const title = (content.match(/<title>(.*?)<\/title>/i) || [,''])[1].trim();
      const h1 = (content.match(/<h1>(.*?)<\/h1>/i) || [,''])[1].trim();
      const val = title || h1;
      if (val) { appNameInput.value = val; updatePackageName(); }
    };
    r.readAsText(htmlFile);
  }

  function updatePackageName() {
    let appName = appNameInput.value.trim();
    if (!appName) { pkgInput.value=''; return; }
    let pkgName = appName.toLowerCase().replace(/\s+/g,'.').replace(/[^a-z0-9.]/g,'');
    pkgName = pkgName.replace(/^[^a-z]+/,'').replace(/\.+/g,'.').replace(/^\./,'');
    if (!pkgName) pkgName='my.app';
    if (!pkgName.includes('.')) pkgName=`my.${pkgName}`;
    if (!pkgName.startsWith('com.') && !pkgName.startsWith('net.') && !pkgName.startsWith('org.')) pkgName=`com.${pkgName}`;
    pkgInput.value = pkgName;
  }

  function displayFiles() {
    filesDiv.innerHTML = '';
    const files = [htmlFile, assetsZipFile, iconFile].filter(Boolean);
    files.forEach(file => {
      const chip = document.createElement('span'); chip.className='chip'; chip.textContent=file.name;
      const removeBtn = document.createElement('button');
      removeBtn.textContent='‚úï'; removeBtn.style.marginLeft='8px'; removeBtn.style.background='none';
      removeBtn.style.border='none'; removeBtn.style.cursor='pointer'; removeBtn.style.color='var(--mut)';
      removeBtn.onclick=()=>{ if(file===htmlFile) htmlFile=null; if(file===assetsZipFile) assetsZipFile=null; if(file===iconFile) iconFile=null; displayFiles(); checkFormState(); updateAppNameFromHtml(); };
      chip.appendChild(removeBtn); filesDiv.appendChild(chip);
    });
    checkFormState();
  }

  function checkFormState() {
    const hasHtml = !!htmlFile;
    goBtn.disabled = !hasHtml; buildCloudBtn.disabled = !hasHtml; buildApkBtn.disabled = !hasHtml;
    setStatus('info', hasHtml ? 'Ready. Add files and I‚Äôll convert.' : 'Add your HTML file to get started.');
  }

  function handleFiles(files) {
    for (const file of files) {
      const ln = file.name.toLowerCase();
      if (ln.endsWith('.html') || file.type === 'text/html') {
        if (htmlFile) { setStatus('error','Only one HTML file is allowed.'); continue; }
        htmlFile = file; updateAppNameFromHtml();
      } else if (ln.endsWith('.zip') || file.type === 'application/zip') {
        if (assetsZipFile) { setStatus('error','Only one assets ZIP file is allowed.'); continue; }
        assetsZipFile = file;
      } else if (ln.endsWith('.png') || file.type === 'image/png') {
        if (iconFile) { setStatus('error','Only one icon PNG file is allowed.'); continue; }
        iconFile = file;
        const img = new Image(); const url = URL.createObjectURL(file);
        img.onload = () => { if (img.width!==512 || img.height!==512) setStatus('error',`Icon is ${img.width}√ó${img.height}. Play Console wants 512√ó512.`); URL.revokeObjectURL(url); };
        img.src = url;
      } else {
        setStatus('error', `Unsupported file type: ${file.name}`);
      }
    }
    displayFiles();
  }

  pickBtn.addEventListener('click', () => picker.click());
  picker.addEventListener('change', (e) => { handleFiles(e.target.files); picker.value=''; });
  drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('drag'); });
  drop.addEventListener('dragleave', () => drop.classList.remove('drag'));
  drop.addEventListener('drop', e => { e.preventDefault(); drop.classList.remove('drag'); handleFiles(e.dataTransfer.files); });
  drop.addEventListener('keydown', e => { if (e.key==='Enter'||e.key===' ') { e.preventDefault(); picker.click(); } });

  appNameInput.addEventListener('input', () => { updatePackageName(); saveSettings(); });

  goBtn.addEventListener('click', () => {
    if (!htmlFile) return setStatus('error','Please add an HTML file first.');

    const vc = parseInt(verCodeInput.value,10);
    if (!Number.isInteger(vc) || vc<1) return setStatus('error','Version code must be a positive integer.');
    if (!verNameInput.value.trim()) return setStatus('error','Version name cannot be empty.');
    const minSdk = parseInt(minSdkInput.value,10), targetSdk = parseInt(tgtSdkInput.value,10);
    if (Number.isInteger(minSdk) && Number.isInteger(targetSdk) && minSdk>targetSdk) return setStatus('error','Min SDK cannot be greater than Target SDK.');

    setBusy(true); setStatus('info','Preparing conversion...'); setProgress(0);

    const reader = new FileReader();
    reader.onload = () => {
      const appName = appNameInput.value.trim() || 'MyAwesomeApp';
      const pkg = pkgInput.value.trim() || 'com.example.myapp';
      const invalidPkg = !/^[a-z][a-z0-9]*(\.[a-z][a-z0-9]*)+$/.test(pkg);
      if (invalidPkg) { setBusy(false); return setStatus('error','Package name is invalid. Use only [a-z0-9.] with dots between segments, starting with a letter.'); }

      const versionCode = parseInt(verCodeInput.value) || 1;
      const versionName = verNameInput.value.trim() || '1.0';
      const minSdkVal = parseInt(minSdkInput.value) || 21;
      const targetSdkVal = parseInt(tgtSdkInput.value) || 35;
      const permissions = Array.from(new Set(permsInput.value.split(/[\s,]+/).map(s=>s.trim().toUpperCase()).filter(Boolean)));

      const formData = new FormData();
      formData.append('html', htmlFile);
      if (assetsZipFile) formData.append('assets', assetsZipFile);
      if (iconFile) formData.append('icon', iconFile);
      formData.append('appName', appName);
      formData.append('packageName', pkg);
      formData.append('versionCode', versionCode);
      formData.append('versionName', versionName);
      formData.append('minSdk', minSdkVal);
      formData.append('targetSdk', targetSdkVal);
      formData.append('permissions', JSON.stringify(permissions));

      const xhr = new XMLHttpRequest();
      xhr.open('POST', `${CLOUD_BASE}/convert`);   // ‚Üê cloud endpoint
      xhr.timeout = 120000;

      xhr.ontimeout = () => { setBusy(false); setStatus('error','Request timed out. Check server availability or try again.'); };
      xhr.upload.onprogress = (e) => { if (e.lengthComputable){ const pct = (e.loaded/e.total)*100; setProgress(pct); setStatus('info',`Converting... ${Math.round(pct)}%`);} };
      xhr.onload = () => {
        setBusy(false);
        if (xhr.status === 200) {
          let response; try { response = JSON.parse(xhr.responseText); } catch { return setStatus('error','Unexpected response from server (not JSON).'); }
          if (response.success) { setProgress(100); outputDiv.className='success'; outputDiv.innerHTML = `Conversion successful! <a href="${response.downloadUrl}" download="${appName}.aap">Download AAP</a>`; }
          else setStatus('error', `Conversion failed: ${response.error || 'Unknown error'}`);
        } else setStatus('error', `Server error: ${xhr.status} ${xhr.statusText}`);
      };
      xhr.onerror = () => { setBusy(false); setStatus('error','Network error during conversion. Check your connection or the builder URL.'); };
      xhr.send(formData);
    };
    reader.readAsText(htmlFile);
  });

  resetBtn.addEventListener('click', () => {
    htmlFile=null; assetsZipFile=null; iconFile=null; filesDiv.innerHTML='';
    appNameInput.value=''; pkgInput.value=''; verCodeInput.value='1'; verNameInput.value='1.0';
    minSdkInput.value='21'; tgtSdkInput.value='35'; permsInput.value='';
    setStatus('info','Ready. Add files and I‚Äôll convert.'); setProgress(0); checkFormState();
    localStorage.removeItem(APP_STORAGE_KEY + '_appName');
    localStorage.removeItem(APP_STORAGE_KEY + '_pkg');
    localStorage.removeItem(APP_STORAGE_KEY + '_verCode');
    localStorage.removeItem(APP_STORAGE_KEY + '_verName');
    localStorage.removeItem(APP_STORAGE_KEY + '_minSdk');
    localStorage.removeItem(APP_STORAGE_KEY + '_tgtSdk');
    localStorage.removeItem(APP_STORAGE_KEY + '_perms');
  });

  async function startCloudBuild(kind) {
    if (!htmlFile) return setStatus('error','Please add an HTML file first.');
    const appName = appNameInput.value.trim() || 'MyAwesomeApp';
    const pkg = pkgInput.value.trim() || 'com.example.myapp';
    if (!/^[a-z][a-z0-9]*(\.[a-z][a-z0-9]*)+$/.test(pkg)) return setStatus('error','Package name is invalid. Use only [a-z0-9.] with dots between segments, starting with a letter.');
    const versionCode = parseInt(verCodeInput.value) || 1;
    const versionName = verNameInput.value.trim() || '1.0';
    const minSdkVal = parseInt(minSdkInput.value) || 21;
    const targetSdkVal = parseInt(tgtSdkInput.value) || 35;
    const permissions = Array.from(new Set(permsInput.value.split(/[\s,]+/).map(s=>s.trim().toUpperCase()).filter(Boolean)));

    setBusy(true); setProgress(10); setStatus('info', `Uploading for ${kind.toUpperCase()} build‚Ä¶`);

    const formData = new FormData();
    formData.append('html', htmlFile);
    if (assetsZipFile) formData.append('assets', assetsZipFile);
    if (iconFile) formData.append('icon', iconFile);
    formData.append('appName', appName);
    formData.append('packageName', pkg);
    formData.append('versionCode', versionCode);
    formData.append('versionName', versionName);
    formData.append('minSdk', minSdkVal);
    formData.append('targetSdk', targetSdkVal);
    formData.append('permissions', JSON.stringify(permissions));

    try {
      const resp = await fetch(`${CLOUD_BASE}/build/${kind}`, { method:'POST', body: formData, mode:'cors' });
      if (!resp.ok) { setBusy(false); return setStatus('error', `Build start failed: ${resp.status} ${resp.statusText}`); }
      let data; try { data = await resp.json(); } catch { setBusy(false); return setStatus('error','Unexpected response from server (not JSON).'); }
      if (!data.jobId) { setBusy(false); return setStatus('error','No jobId returned by builder.'); }
      setProgress(25); setStatus('info','Build started‚Ä¶');
      await pollJob(data.jobId, appName, kind);
    } catch (err) { setBusy(false); setStatus('error', `Network error: ${err && err.message ? err.message : err}`); }
  }

  async function pollJob(jobId, appName, kind) {
    const pollUrl = `${CLOUD_BASE}/jobs/${encodeURIComponent(jobId)}`;
    let pct = 25;
    const tick = async () => {
      try {
        const r = await fetch(pollUrl, { method:'GET', mode:'cors', cache:'no-store' });
        if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
        const j = await r.json();
        if (j.status === 'queued' || j.status === 'running') {
          pct = Math.min(95, pct + Math.random()*7);
          setProgress(pct); setStatus('info', `Building‚Ä¶ (${j.status})`);
          setTimeout(tick, 1500); return;
        }
        if (j.status === 'error') { setBusy(false); setProgress(0); return setStatus('error', `Build failed: ${j.error || 'Unknown error'}`); }
        if (j.status === 'done' && j.downloadUrl) {
          setBusy(false); setProgress(100);
          outputDiv.className='success';
          outputDiv.innerHTML = `Build complete! <a href="${j.downloadUrl}" download="${appName}.${kind}">${kind.toUpperCase()}</a>`;
          return;
        }
        setBusy(false); setStatus('error','Unknown job state from builder.');
      } catch(e){ setBusy(false); setStatus('error', `Polling error: ${e && e.message ? e.message : e}`); }
    };
    setTimeout(tick, 1200);
  }

  buildCloudBtn.addEventListener('click', () => startCloudBuild('aab'));
  buildApkBtn.addEventListener('click', () => startCloudBuild('apk'));

  function loadSettings(){ ['_appName','_pkg','_verCode','_verName','_minSdk','_tgtSdk','_perms'].forEach(k=>{
    const elMap={_appName:appNameInput,_pkg:pkgInput,_verCode:verCodeInput,_verName:verNameInput,_minSdk:minSdkInput,_tgtSdk:tgtSdkInput,_perms:permsInput};
    const v=localStorage.getItem(APP_STORAGE_KEY+k); if(v!==null) elMap[k].value=v;
  }); }
  function saveSettings(){ localStorage.setItem(APP_STORAGE_KEY+'_appName', appNameInput.value);
    localStorage.setItem(APP_STORAGE_KEY+'_pkg', pkgInput.value);
    localStorage.setItem(APP_STORAGE_KEY+'_verCode', verCodeInput.value);
    localStorage.setItem(APP_STORAGE_KEY+'_verName', verNameInput.value);
    localStorage.setItem(APP_STORAGE_KEY+'_minSdk', minSdkInput.value);
    localStorage.setItem(APP_STORAGE_KEY+'_tgtSdk', tgtSdkInput.value);
    localStorage.setItem(APP_STORAGE_KEY+'_perms', permsInput.value); }

  appNameInput.addEventListener('input', saveSettings);
  pkgInput.addEventListener('input', saveSettings);
  verCodeInput.addEventListener('input', saveSettings);
  verNameInput.addEventListener('input', saveSettings);
  minSdkInput.addEventListener('input', saveSettings);
  tgtSdkInput.addEventListener('input', saveSettings);
  permsInput.addEventListener('input', saveSettings);

  window.addEventListener('load', () => { loadSettings(); checkFormState(); if (!htmlFile) setStatus('info','Add your HTML file to get started.'); });
  document.body.addEventListener('dblclick', e => e.preventDefault());
</script>
</body>
</html>
